<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        .divcss5 {
            border: 1px solid #F00;
            width: 200px;
            height: 100px
        }
    </style>
    <link rel="icon" type="image/x-icon" href="img/head/favicon.ico" />
    <link rel="stylesheet" href="css/foot.css"/>
    <link rel="stylesheet" href="css/head.css"/>
    <meta http-equiv="Content-type" content="text/html; charset=UTF-8"/>
    <noscript>æŠ±æ­‰ï¼Œä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ JavaScript!</noscript>
    <script type="text/javascript" src="js/base-v1.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery-1.2.6.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/cookie.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/common.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery.cookie.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery-extend.js"></script>
    <script type="text/javascript" src="js/lib-v1.js" charset="utf-8"></script>
    <link href="css/prodList.css" rel="stylesheet" type="text/css">
    <link href="css/prodInfo.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="js/logout.js"></script>
    <script type="text/javascript" src="js/productinfo.js"></script>
    <meta charset="UTF-8">
    <title>å•†å“åˆ†é¡µ</title>
    <script type="text/javascript">
        var userId = "";
        var productId = "";
        window.onload = function () {
            let localUrl = decodeURI(window.location.href);
            //alert(localUrl);
            productId = localUrl.split("?")[1].split("=")[1];
            $.ajax({
                url: "http://www.supermarket.com/products/item/" + productId,
                dataType: "json",
                type: "POST",
                success: function (data) {
                    //å›¾ç‰‡
                    let imgUrl = data.productImgurl;
                    console.log(imgUrl);
                    productId = data.productId;
                    document.getElementById("prod_img").src = imgUrl;
                    document.getElementById("prod_name").innerText = data.productName;
                    document.getElementById("prod_desc").innerText = data.productDescription;
                    document.getElementById("prod_pric").innerText = data.productPrice;
                    document.getElementById("prod_num").innerText = data.productNum;
                }
            });
            let _ticket = $.cookie("EM_TICKET");
            let userPassword = $.cookie("PASSWORD");
            let userName = $.cookie("USERNAME");
            //alert(_ticket);
            if (!_ticket) {
                if (!userPassword || !userName)
                    // äºŒè€…ç¼ºä¸€æ— æ³•è‡ªåŠ¨ç™»å½•
                    return;
                else{
                    autoLogin(userName, userPassword);
                    return;
                }
            }

            //å½“dataTypeç±»å‹ä¸ºjsonpæ—¶ï¼ŒjQueryå°±ä¼šè‡ªåŠ¨åœ¨è¯·æ±‚é“¾æ¥ä¸Šå¢åŠ ä¸€ä¸ªcallbackçš„å‚æ•°
            $.ajax({
                url: "http://www.supermarket.com/user/query/" + _ticket,
                dataType: "json",
                type: "GET",
                success: function (data) {
                    if (data.status === 200) {
                        let _data = JSON.parse(data.data);//jackson
                        let html = _data.userName +
                            "ï¼Œæ¬¢è¿æ¥åˆ°Supermarketï¼<a href='javascript:void(0)' class='link-logout' onclick='logout()'>[é€€å‡º]</a>";
                        if (_data.userType >= 3)
                            html = html + "&nbsp;&nbsp;|&nbsp;&nbsp;<a href='http://www.Supermarket.com/manage.html' class='link-logout'>[åå°]</a>";
                        userId = _data.userId;
                        $("#loginbar").html(html);
                    }else if (data.status === 201){
                        // åœ¨redisä¸­æ²¡æ‰¾åˆ°ç”¨æˆ·
                        delCookie("EM_TICKET");
                        delCookie("USERNAME");
                        delCookie("PASSWORD");
                    }else if (data.status === 500){
                        alert(data.msg);
                    }
                },
                error: function () {
                    alert("è¯·æ±‚å¤±è´¥");
                }
            });
        }

        function addCart() {
            if (userId === "") {
                window.location.href = "login.html";
                return;
            }
            let num = document.getElementById("buyNumInp").value;
            let total = parseInt(document.getElementById("prod_num").innerText);
            if (num > total) {
                alert("æœ€å¤šè´­ä¹°"+total+"ä¸ª");
                return;
            }
            $.ajax({
                url: "http://www.supermarket.com/cart/save?userId=" + userId + "&productId=" + productId + "&num=" + num,
                dataType: "json",
                type: "GET",
                success: function (data) {
                    if (data.status === 200) {
                        window.location.href = "http://www.supermarket.com/mycart.html?userId=" + userId;
                    } else {
                        alert(data.msg);
                    }
                },
                error: function () {
                    alert("è¯·æ±‚å¤±è´¥");
                }
            });
        }

        /**
         * è‡ªåŠ¨ç™»å½•
         * @param userName ç”¨æˆ·å
         * @param userPassword å¯†ç 
         */
        function autoLogin(userName, userPassword) {
            $.ajax({
                url:"http://www.supermarket.com/user/autologin",
                type:"get",
                data:{
                    "userName": userName,
                    "userPassword": userPassword
                },
                dataType:"json",
                success: function (data) {
                    if (data.status === 200) {
                        let _data = data.data;//jackson
                        let html = _data.userName +
                            "ï¼Œæ¬¢è¿æ¥åˆ°Supermarketï¼<a href='javascript:void(0)' class='link-logout' onclick='logout()'>[é€€å‡º]</a>";
                        if (_data.userType >= 3)
                            html = html + "&nbsp;&nbsp;|&nbsp;&nbsp;<a href='http://www.Supermarket.com/manage.html' class='link-logout'>[åå°]</a>";
                        userId = _data.userId;
                        $("#loginbar").html(html);
                    }else if (data.status === 500){
                        alert(data.msg);
                    }
                },
                error: function () {
                    alert('è¯·æ±‚å¤±è´¥');
                }
            });
        }


        function search(a) {
            let query = document.getElementById(a).value;
            //alert(query);
            window.location.href = "./search.html?query=" + query;
        }
    </script>
</head>

<body>
<div id="common_head">
    <div class="line1">
        <div class="content">
            <ul>
                <li class="fore1" id="loginbar" clstag="homepage|keycount|home2013|01b">
                    <span id="head_span">
                        <a href="login.html">ç™»å½•</a>&nbsp;&nbsp;|&nbsp;&nbsp;
                        <a href="regist.html">æ³¨å†Œ</a>
                    </span>
                </li>
            </ul>
        </div>
    </div>
    <div class="line2">
        <img id="logo" src="img/head/logo.png" alt="logo"/>
        <input type="text" value="" accesskey="s" id="key" autocomplete="off"
               onkeydown="if(event.keyCode===13) search('key');"/>
        <input type="button" value="æœ ç´¢" onclick="search('key')"/>
        <span id="goto">
			<a id="goto_order" href="./myorder.html">æˆ‘çš„è®¢å•</a>
			<a id="goto_cart" href="./mycart.html">æˆ‘çš„è´­ç‰©è½¦</a>
		</span>
        <img id="erwm" src="img/head/e2.png" alt="e2" width="76"/>
    </div>
    <div class="line3">
        <div class="content">
            <ul>
                <li><a href="./index.html">é¦–é¡µ</a></li>
                <li><a href="./product-list.html?page=1&rows=30">å…¨éƒ¨å•†å“</a></li>
                <li><a href="./instant-buy.html">ç§’æ€å•†å“</a></li>
                <li><a href="javascript:void(0)">ç”µè„‘å¹³æ¿</a></li>
                <li><a href="javascript:void(0)">å®¶ç”¨ç”µå™¨</a></li>
                <li><a href="javascript:void(0)">æ±½è½¦ç”¨å“</a></li>
                <li><a href="javascript:void(0)">é£Ÿå“é¥®æ–™</a></li>
                <li><a href="javascript:void(0)">å›¾ä¹¦æ‚å¿—</a></li>
                <li><a href="javascript:void(0)">æœè£…æœé¥°</a></li>
                <li><a href="javascript:void(0)">å¤§è‹±ç†è´¢</a></li>
            </ul>
        </div>
    </div>
</div>

<div id="warp">
    <div id="left">
        <div id="left_top">
            <img src="" id="prod_img" alt="prod_img"/>
        </div>
        <div id="left_bottom"></div>
    </div>
    <div id="right">
        <div id="right_top">
            <span id="prod_name"><br/></span>
            <br>
            <span id="prod_desc"><br/></span>
        </div>
        <div id="right_middle">
				<span id="right_middle_span">
                    supermarket ä»·ï¼š<span class="price_red" id="prod_pric">1111</span>å…ƒ<br/>
			            è¿     è´¹ï¼šæ»¡ 100 å…è¿è´¹<br/>
			            æœ     åŠ¡ï¼šç”±supermarketè´Ÿè´£å‘è´§ï¼Œå¹¶æä¾›å”®åæœåŠ¡<br/>
                    åº“å­˜ï¼š<span id="prod_num">1111</span>ä»¶<br/>
                    <label for="buyNumInp">è´­ä¹°æ•°é‡ï¼š</label>
	                <a href="javascript:void(0)" id="delNum" onclick="change(-1)">-</a>
	                <input id="buyNumInp" name="buyNum" type="text" value="1"/>
		            <a href="javascript:void(0)" id="addNum" onclick="change(1)">+</a>
                </span>
        </div>
        <div id="right_bottom">
            <input class="add_cart_but" type="button" onclick="addCart()" value="ğŸ›’ åŠ å…¥è´­ç‰©è½¦"/>
        </div>
    </div>
</div>

<div id="common_foot">
    <p>
        Copyright Â© 2011-2019 ç½‘ä¸Šå•†åŸ ç‰ˆæƒæ‰€æœ‰ ä¿ç•™ä¸€åˆ‡æƒåˆ© ç²¤CM-20201119 | ç²¤ICPå¤‡20201119å·-1
        <br />
        ç²¤å…¬ç½‘å®‰å¤‡  20201119å·
    </p>
</div>
</body>
</html>